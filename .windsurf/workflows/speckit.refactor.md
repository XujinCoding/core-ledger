
```markdown
---
description: 基于项目规范(constitution)重新设计代码架构，完成新代码开发并替换旧代码的重构分析。
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前，您**必须**考虑用户输入（如果非空）。

## 大纲

用户在触发消息中输入 `/speckit.refactor` 后的文本**就是**重构需求描述。假设您在此对话中始终可以使用它，即使 `{{args}}` 在下面字面上出现。除非用户提供了空命令，否则不要要求用户重复。

根据该功能描述，请执行以下操作：

1. **创建重构分析文档**：
   
   a. 通过对话上下文中获取jira任务号`<jira-task>`，如对话上下文中未提供，则必须输出以下提示，并等待用户输入：
      ```markdown
      请输入本次任务的jira任务号`<jira-task>`
      在用户输入前不得继续执行。
      ``` 
   
   b. 创建本次规范文档目录, 运行命令：`mkdir -p "specs/<jira-task>"`
   
   c. 复制重构分析模板文件, 运行命令：`cp ".specify/templates/refactor-template.md" "specs/<jira-task>/spec.md"`
   
2. 加载 `.specify/templates/refactor-template.md` 以了解必需的部分, 加载`.specify/memory/constitution.md`以了解项目规范和最佳实践。

3. **重构核心逻辑**：基于constitution文件重新思考代码架构，完成符合规范的新代码开发，并替换旧代码。

4. 遵循此执行流程：

    1. 从输入中解析重构需求描述
       如果为空：错误 "未提供重构需求描述"
    2. **基于constitution的重新设计**：
       - 忽略现有代码的具体实现细节
       - 基于constitution中的架构原则和设计模式重新思考
       - 定义符合项目规范的新架构目标
    3. **新代码开发策略**：
       - 严格遵循constitution中的编码标准和最佳实践
       - 设计模块化、可维护、可测试的代码结构
       - 确保新架构支持未来的扩展性和可维护性
    4. **渐进式替换策略**：
       - 制定从旧代码到新代码的渐进迁移计划
       - 定义明确的接口边界和迁移阶段
       - 确保在迁移过程中系统功能完整性
    5. 对于不清楚的方面：
       - 基于constitution规范做出技术决策
       - 仅在以下情况下标记为 [NEEDS CLARIFICATION: 具体问题]：
         - constitution中缺少必要的技术指导
         - 存在多个符合constitution的合理方案，且具有不同的影响
         - 需要业务上下文才能做出的技术决策
       - **限制：最多 3 个 [NEEDS CLARIFICATION] 标记**
       - 按影响优先排序：架构一致性 > 性能目标 > 维护性标准 > 实现细节
    6. 填写重构影响分析部分
       重点分析新架构与constitution的符合程度
    7. 生成重构方案选项
       每个方案必须基于constitution原则，包含架构一致性和规范符合度分析
       为未指定的技术细节使用constitution中的默认标准
    8. 定义重构成功标准
       创建基于constitution规范的可测量指标
       包括架构一致性指标、代码规范符合度、质量属性改进
       每个标准必须可以在重构后通过constitution验证
    9. 识别关键架构组件和依赖关系
       基于constitution中的架构模式定义新的组件边界

5. 使用模板结构将重构分析写入 `specs/<jira-task>/spec.md` ，用从重构需求（参数）和constitution派生的具体细节替换占位符，同时保留部分顺序和标题。

6. **规范质量验证**：在编写初始规范后，根据质量标准验证它：

   a. **创建规范质量检查表**：使用检查表模板结构在 `specs/<jira-task>/checklists/requirements.md` 生成检查表文件，包含以下验证项目：

      ```markdown
      # 重构分析质量检查表: [重构任务名称]

      **目的**: 在进行重构实施之前验证分析的完整性和质量
      **创建**: [日期]
      **重构分析**: [链接到 spec.md]

      ## 内容质量

      - [ ] 清晰描述了基于constitution重新设计的必要性
      - [ ] 重构目标与constitution原则一致
      - [ ] 新架构设计完全基于constitution规范
      - [ ] 所有必填部分已完成
      - [ ] 避免了现状优先的思维定式

      ## 技术分析完整性

      - [ ] 没有 [NEEDS CLARIFICATION] 标记
      - [ ] 重构方案选项基于constitution原则
      - [ ] 架构决策有constitution依据
      - [ ] 风险评估考虑了架构迁移的影响
      - [ ] 成功标准基于constitution的可测量指标
      - [ ] 新组件边界符合constitution架构模式
      - [ ] 渐进式迁移策略安全可行

      ## 重构准备就绪

      - [ ] 所有重构步骤都有明确的验收标准
      - [ ] 测试策略符合constitution要求
      - [ ] 性能目标基于constitution标准
      - [ ] 代码规范检查计划已定义
      - [ ] 架构一致性验证方法明确

      ## 备注

      - 标记为不完整的项目在 `/speckit.plan` 之前需要规范更新
      ```

   b. **运行验证检查**：根据每个检查表项目审查重构分析：
      - 对于每个项目，确定它是通过还是失败
      - 记录发现的具体问题（引用相关的分析部分）

   c. **处理验证结果**：

      - **如果所有项目都通过**：标记检查表为完成并继续执行第 7 步

      - **如果项目失败（不包括 [NEEDS CLARIFICATION]）**：
        1. 列出失败的项目和具体问题
        2. 更新规范以解决每个问题
        3. 重新运行验证，直到所有项目都通过（最多 3 次迭代）
        4. 如果在 3 次迭代后仍然失败，请在检查表备注中记录剩余问题并警告用户

      - **如果存在 [NEEDS CLARIFICATION] 标记**：
        1. 从规范中提取所有 [NEEDS CLARIFICATION: ...] 标记
        2. **限制检查**：如果存在超过 3 个标记，则仅保留 3 个最关键（按架构影响/规范符合度）的标记，并基于constitution对其余标记做出决策
        3. 对于每个需要的澄清（最多 3 个），以以下格式向用户呈现选项：

           ```markdown
           ## 问题 [N]: [主题]
           
           **上下文**: [引用相关的分析部分和constitution依据]
           
           **我们需要知道**: [来自 NEEDS CLARIFICATION 标记的具体问题]
           
           **建议答案**:
           
           | 选项 | 答案 | 含义 |
           |------|------|------|
           | A    | [第一个基于constitution的建议] | [这对架构实施意味着什么] |
           | B    | [第二个基于constitution的建议] | [这对架构实施意味着什么] |
           | C    | [第三个基于constitution的建议] | [这对架构实施意味着什么] |
           | 自定义 | 提供您自己的答案 | [解释如何提供自定义输入] |
           
           **您的选择**: _[等待用户响应]_
           ```

        4. **关键 - 表格格式**：确保 markdown 表格格式正确
        5. 问题编号按顺序（Q1、Q2、Q3 - 最多 3 个）
        6. 在等待响应之前一起呈现所有问题
        7. 等待用户响应他们对所有问题的选择
        8. 通过将每个 [NEEDS CLARIFICATION] 标记替换为用户选择或提供的答案来更新规范
        9. 在所有澄清解决后重新运行验证

   d. **更新检查表**：在每次验证迭代后，使用当前的通过/失败状态更新检查表文件

7. 报告完成情况，包括jira任务号、分析文档路径、检查表结果以及下一阶段（`/speckit.plan`）的准备情况。

## 通用指南

## 快速指南

- **核心原则**：基于constitution重新思考，避免现状偏见
- 专注于**应该是什么**而不是**现在是什么**
- 为技术领导和架构师编写，强调基于规范的架构决策
- 不要创建任何嵌入在分析文档中的检查表

### 部分要求

- **必填部分**：每个重构分析都必须完成
- **可选部分**：仅在与重构类型相关时包括
- 当某个部分不适用时，完全删除它

### 对于 AI 生成

从用户提示创建此规范时：

1. **基于constitution决策**：所有技术决策必须基于constitution文件中的原则和标准
2. **避免现状偏见**：不要被现有实现限制思考，专注于理想架构
3. **记录规范依据**：在假设部分记录每个重要决策的constitution依据
4. **限制澄清需求**：最多 3 个 [NEEDS CLARIFICATION] 标记 - 仅用于constitution中未涵盖的关键决策
5. **优先架构澄清**：架构原则符合度 > 代码质量标准 > 实现模式

**基于constitution的默认决策**（不要询问这些）：

- 架构模式：constitution中定义的架构风格和模式
- 代码质量标准：constitution中指定的代码规范和最佳实践
- 测试策略：constitution中要求的测试方法和覆盖率
- 性能标准：constitution中定义的性能目标和SLA

### 成功标准指南

成功标准必须是：

1. **基于constitution的可测量指标**：直接关联constitution中的具体标准
2. **架构导向的**：衡量架构质量和规范符合度
3. **前瞻性的**：支持未来扩展和维护需求
4. **可验证的**：可以通过constitution中的验证方法进行测试

**基于constitution的成功标准示例**：

- "新架构100%符合constitution中的微服务原则"
- "代码规范检查通过率从70%提升到95%"
- "模块耦合度降低到constitution定义的目标范围内"
- "测试覆盖率达成constitution要求的85%标准"
